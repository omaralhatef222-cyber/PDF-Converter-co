<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Multi-Image to PDF Converter</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>

    <style>
        :root {
            /* Premium Color Palette */
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --text-color: #212529;
            --border-color: #e0e0e0;
            --primary-color: #4A4AFF;
            --primary-hover: #3A3AFF;
            --secondary-color: #6c757d;
            --secondary-hover: #5a6268;
            --danger-color: #dc3545;
            --danger-hover: #c82333;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Poppins', sans-serif;
            display: grid;
            place-items: center;
            min-height: 90vh;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding: 2rem;
            transition: background-color 0.3s, color 0.3s;
        }
        
        body.dark-mode {
            --bg-color: #2c2c2c;
            --container-bg: #383838;
            --text-color: #f1f1f1;
            --border-color: #444;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --primary-color: #6666FF; 
            --primary-hover: #7777FF;
        }

        #imageInput { 
            height: 0;
            width: 0;
            overflow: hidden;
            opacity: 0;
            position: absolute;
            z-index: -1; 
        }

        .container {
            background: var(--container-bg);
            padding: 2.5rem; 
            border-radius: 16px; 
            box-shadow: 0 10px 30px var(--shadow-color), 0 0 0 1px var(--border-color);
            text-align: center;
            width: 100%;
            max-width: 600px;
            border: 3px dashed transparent; 
            transition: all 0.3s ease;
        }
        .container.drag-over {
            border-color: var(--primary-color);
            background-color: var(--bg-color);
        }
        
        h2 { 
            margin-top: 0; 
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        h2 .brand-icon {
            color: var(--primary-color);
            font-size: 1.5em;
        }
        p { font-weight: 400; color: #666; }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
            text-align: left;
        }
        .setting-item {
            display: flex;
            flex-direction: column;
        }
        .setting-item label {
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        .setting-item input[type="text"], .setting-item select {
            border: 1px solid #ccc;
            transition: border-color 0.3s;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.9rem;
            background-color: var(--container-bg);
            color: var(--text-color);
            width: 100%;
            box-sizing: border-box;
        }
        .setting-item input[type="text"]:focus, .setting-item select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px var(--primary-color)30;
            outline: none;
        }
        .setting-item.full-width {
            grid-column: 1 / -1; 
        }

        .button-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .upload-label, #convertBtn, #clearBtn {
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            padding: 14px 28px; 
            font-size: 1rem;
            font-weight: 600;
            border-radius: 12px;
            box-shadow: 0 2px 5px var(--shadow-color);
        }
        .upload-label {
            background-color: var(--secondary-color);
            color: white;
        }
        .upload-label:hover { background-color: var(--secondary-hover); }
        
        #convertBtn {
            background-color: var(--primary-color);
            color: white;
            min-width: 220px;
        }
        #convertBtn:hover, #clearBtn:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }
        
        #clearBtn {
            background-color: var(--danger-color);
            color: white;
        }
        
        button:disabled {
            background-color: #888;
            cursor: not-allowed;
        }
        
        #progress-bar-container {
            width: 100%;
            background-color: var(--border-color);
            border-radius: 5px;
            margin-top: 1.5rem;
            display: none; 
        }
        #progress-bar {
            width: 0%;
            height: 20px;
            background-color: var(--primary-color);
            border-radius: 5px;
            text-align: center;
            color: white;
            font-weight: bold;
            line-height: 20px;
            font-size: 0.8rem;
            transition: width 0.2s ease-out;
        }
        
        #fileList {
            margin-top: 1.5rem;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
        }
        #fileListNames {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        #fileList .error { 
            color: var(--danger-color); 
            font-style: italic; 
            padding: 1rem; 
            text-align: center;
        }
        #fileList .empty-text {
            color: #888;
            text-align: center;
            padding: 2rem 0;
        }
        
        .preview-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            cursor: move; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s ease;
        }
        .preview-card.sortable-ghost {
            opacity: 0.4;
            background: var(--accent-light);
        }
        .preview-card.sortable-chosen {
            box-shadow: 0 6px 15px var(--primary-color)50;
            transform: translateY(-2px);
            cursor: grabbing;
        }
        
        .preview-number {
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--primary-color);
            width: 25px; 
            text-align: right;
        }
        
        .preview-img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            transition: transform 0.3s ease; 
        }
        .preview-img.rotate-90  { transform: rotate(90deg); }
        .preview-img.rotate-180 { transform: rotate(180deg); }
        .preview-img.rotate-270 { transform: rotate(270deg); }
        
        .preview-name {
            flex-grow: 1;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .preview-controls {
            display: flex;
            gap: 5px;
        }
        .rotate-btn, .delete-btn {
            background: var(--gray-light);
            color: var(--gray-dark);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1rem;
            line-height: 1;
            transition: all 0.2s;
        }
        .rotate-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: rotate(90deg);
        }
        .delete-btn:hover {
            background: var(--danger-color);
            color: white;
        }
        
        [dir="rtl"] { text-align: right; }
        [dir="rtl"] .top-bar { right: auto; left: 20px; }
        [dir="rtl"] .settings-grid { text-align: right; }
        [dir="rtl"] .setting-item label { margin-right: 0; }
        [dir="rtl"] #fileList { text-align: right; }
        [dir="rtl"] .preview-card { flex-direction: row-reverse; }
        [dir="rtl"] .preview-name { text-align: right; }
        [dir="rtl"] .preview-controls { margin-right: auto; }
        
        .bmc-container { margin-top: 2.5rem; text-align: center; }
        
        footer { text-align: center; padding: 1rem 0; margin-top: 1rem; font-size: 0.85rem; color: #888; }
        [dir="rtl"] footer { direction: ltr; }
        
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="lang-select-wrapper">
            <label for="languageSelect" data-i18n-key="language">Language:</label>
            <select id="languageSelect">
                <option value="en">English</option>
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                <option value="tr">T√ºrk√ße</option>
            </select>
        </div>
        
        <div class="theme-switch-wrapper">
            <span>üåô</span>
            <label class="theme-switch">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
            </label>
            <span>‚òÄÔ∏è</span>
        </div>
    </div>

    <div class="container" id="dropZone">
        <h2 data-i18n-key="title">
            <span class="brand-icon">&#x1F4C4;</span>
            Multi-Image to PDF Converter
        </h2>
        <p data-i18n-key="drop-prompt">Drag & drop your JPG/PNG images here, or click to browse.</p>
        
        <input type="file" id="imageInput" accept="image/jpeg, image/png" multiple>
        
        <div class="settings-grid">
            <div class="setting-item full-width">
                <label for="fileNameInput" data-i18n-key="fileName">File Name (optional):</label>
                <input type="text" id="fileNameInput" data-i18n-placeholder="fileNamePlaceholder">
            </div>
            <div class="setting-item">
                <label for="pageSizeSelect" data-i18n-key="pageSize">Page Size:</label>
                <select id="pageSizeSelect">
                    <option value="a4" selected>A4</option>
                    <option value="letter">Letter</option>
                </select>
            </div>
            <div class="setting-item">
                <label for="pageOrientationSelect" data-i18n-key="orientation">Orientation:</label>
                <select id="pageOrientationSelect">
                    <option value="p" data-i18n-key="portrait">Portrait</option>
                    <option value="l" data-i18n-key="landscape">Landscape</option>
                </select>
            </div>
            <div class="setting-item full-width">
                <label for="qualitySelect" data-i18n-key="quality">Image Quality:</label>
                <select id="qualitySelect">
                    <option value="1.0" data-i18n-key="qVeryHigh">Very High (Max Quality)</option>
                    <option value="0.95" data-i18n-key="qHigh">High (Best Quality)</option>
                    <option value="0.75" data-i18n-key="qMedium" selected>Medium (Good Balance)</option>
                    <option value="0.5" data-i18n-key="qLow">Low (Smallest Size)</option>
                </select>
            </div>
        </div>
        
        <div class="button-group">
            <label for="imageInput" class="upload-label" data-i18n-key="browse">Browse Files</label>
            <button id="convertBtn" disabled data-i18n-key="convert">Convert to PDF</button>
            <button id="clearBtn" disabled data-i18n-key="clear">Clear All</button>
        </div>
        
        <div id="progress-bar-container">
            <div id="progress-bar">0%</div>
        </div>

        <div id="fileList">
            <p id="reorder-note" style="text-align: center; color: #888; font-size: 0.85rem; display: none;" data-i18n-key="reorderNote">
                You can drag and drop images to reorder them.
            </p>
            <div id="fileListNames">
                </div>
        </div>
    </div>
    
    <div class="bmc-container">
        <script data-name="BMC-Widget" data-cfasync="false" src="https://cdnjs.buymeacoffee.com/1.0.0/widget.prod.min.js" data-id="omarco" data-description="Support me on Buy me a coffee!" data-message="Thanks for visiting, now you can buy me a coffee:)" data-color="#5F7FFF" data-position="Right" data-x_margin="18" data-y_margin="18"></script>
    </div>
    
    <footer>
        <p>&copy; 2025 OMAR-CO. All rights reserved.</p>
    </footer>

    <script>
        const { jsPDF } = window.jspdf;
        
        const translations = {
            en: {
                title: "Multi-Image to PDF Converter",
                "drop-prompt": "Drag & drop your JPG/PNG images here, or click to browse.",
                fileName: "File Name (optional):",
                fileNamePlaceholder: "converted-images",
                pageSize: "Page Size:",
                orientation: "Orientation:",
                portrait: "Portrait",
                landscape: "Landscape",
                quality: "Image Quality:",
                qVeryHigh: "Very High (Max Quality)",
                qHigh: "High (Best Quality)",
                qMedium: "Medium (Good Balance)",
                qLow: "Low (Smallest Size)",
                browse: "Browse Files",
                convert: "Convert to PDF",
                clear: "Clear All",
                reorderNote: "You can drag and drop images to reorder them.",
                language: "Language:",
                convertN: (n) => `Convert ${n} Image(s) to PDF`,
                empty: "No files selected.",
                errorType: "Error: Some files were skipped. Only .jpg or .png are allowed.",
                progress: (i, n) => `Processing image ${i}/${n}`,
                progressPercent: (p) => `${p}%`,
                saving: "Saving...",
                alertFinish: "Conversion finished!",
                alertSuccess: (s) => `${s} images were converted successfully.`,
                alertFail: (f) => `${f} files failed and were skipped:`,
                alertError: "A critical error occurred. Please refresh the page and try again with fewer files."
            },
            ar: {
                title: "ŸÖÿ≠ŸàŸÑ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿ™ÿπÿØÿØÿ© ÿ•ŸÑŸâ PDF",
                "drop-prompt": "ÿßÿ≥ÿ≠ÿ® Ÿàÿ£ŸÅŸÑÿ™ ÿµŸàÿ± JPG/PNG ŸáŸÜÿßÿå ÿ£Ÿà ÿßŸÜŸÇÿ± ŸÑŸÑÿ™ÿµŸÅÿ≠.",
                fileName: "ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ (ÿßÿÆÿ™Ÿäÿßÿ±Ÿä):",
                fileNamePlaceholder: "ÿµŸàÿ±-ŸÖÿ≠ŸàŸÑÿ©",
                pageSize: "ÿ≠ÿ¨ŸÖ ÿßŸÑÿµŸÅÿ≠ÿ©:",
                orientation: "ÿßŸÑÿßÿ™ÿ¨ÿßŸá:",
                portrait: "ÿπŸÖŸàÿØŸä",
                landscape: "ÿ£ŸÅŸÇŸä",
                quality: "ÿ¨ŸàÿØÿ© ÿßŸÑÿµŸàÿ±ÿ©:",
                qVeryHigh: "ÿπÿßŸÑŸäÿ© ÿ¨ÿØŸãÿß (ÿ£ŸÇÿµŸâ ÿ¨ŸàÿØÿ©)",
                qHigh: "ÿπÿßŸÑŸäÿ© (ÿ£ŸÅÿ∂ŸÑ ÿ¨ŸàÿØÿ©)",
                qMedium: "ŸÖÿ™Ÿàÿ≥ÿ∑ÿ© (ÿ™Ÿàÿßÿ≤ŸÜ ÿ¨ŸäÿØ)",
                qLow: "ŸÖŸÜÿÆŸÅÿ∂ÿ© (ÿ£ÿµÿ∫ÿ± ÿ≠ÿ¨ŸÖ)",
                browse: "ÿ™ÿµŸÅÿ≠ ÿßŸÑŸÖŸÑŸÅÿßÿ™",
                convert: "ÿ™ÿ≠ŸàŸäŸÑ ÿ•ŸÑŸâ PDF",
                clear: "ŸÖÿ≥ÿ≠ ÿßŸÑŸÉŸÑ",
                reorderNote: "ŸäŸÖŸÉŸÜŸÉ ÿ≥ÿ≠ÿ® Ÿàÿ•ŸÅŸÑÿßÿ™ ÿßŸÑÿµŸàÿ± ŸÑÿ•ÿπÿßÿØÿ© ÿ™ÿ±ÿ™Ÿäÿ®Ÿáÿß.",
                language: "ÿßŸÑŸÑÿ∫ÿ©:",
                convertN: (n) => `ÿ™ÿ≠ŸàŸäŸÑ ${n} ÿµŸàÿ±ÿ© (ÿµŸàÿ±) ÿ•ŸÑŸâ PDF`,
                empty: "ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÖŸÑŸÅÿßÿ™.",
                errorType: "ÿÆÿ∑ÿ£: ÿ™ŸÖ ÿ™ÿÆÿ∑Ÿä ÿ®ÿπÿ∂ ÿßŸÑŸÖŸÑŸÅÿßÿ™. ŸÖÿ≥ŸÖŸàÿ≠ ŸÅŸÇÿ∑ ÿ®ŸÖŸÑŸÅÿßÿ™ .jpg ÿ£Ÿà .png.",
                progress: (i, n) => `ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿµŸàÿ±ÿ© ${i}/${n}`,
                progressPercent: (p) => `%${p}`,
                saving: "ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ≠ŸÅÿ∏...",
                alertFinish: "ÿßŸÉÿ™ŸÖŸÑ ÿßŸÑÿ™ÿ≠ŸàŸäŸÑ!",
                alertSuccess: (s) => `ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ${s} ÿµŸàÿ±ÿ© ÿ®ŸÜÿ¨ÿßÿ≠.`,
                alertFail: (f) => `ŸÅÿ¥ŸÑ ÿ™ÿ≠ŸàŸäŸÑ ${f} ŸÖŸÑŸÅÿßÿ™ Ÿàÿ™ŸÖ ÿ™ÿÆÿ∑ŸäŸáÿß:`,
                alertError: "ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅÿßÿØÿ≠. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿµŸÅÿ≠ÿ© ŸàÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ŸÖŸÑŸÅÿßÿ™ ÿ£ŸÇŸÑ."
            },
            tr: {
                title: "√áoklu Resimden PDF'e D√∂n√º≈üt√ºr√ºc√º",
                "drop-prompt": "JPG/PNG resimlerinizi buraya s√ºr√ºkleyip bƒ±rakƒ±n veya g√∂z atmak i√ßin tƒ±klayƒ±n.",
                fileName: "Dosya Adƒ± (isteƒüe baƒülƒ±):",
                fileNamePlaceholder: "donusturulen-resimler",
                pageSize: "Sayfa Boyutu:",
                orientation: "Y√∂nelim:",
                portrait: "Dikey",
                landscape: "Yatay",
                quality: "Resim Kalitesi:",
                qVeryHigh: "√áok Y√ºksek (Maks Kalite)",
                qHigh: "Y√ºksek (En ƒ∞yi Kalite)",
                qMedium: "Orta (ƒ∞yi Denge)",
                qLow: "D√º≈ü√ºk (En K√º√ß√ºk Boyut)",
                browse: "Dosyalara G√∂z At",
                convert: "PDF'e D√∂n√º≈üt√ºr",
                clear: "T√ºm√ºn√º Temizle",
                reorderNote: "Yeniden sƒ±ralamak i√ßin resimleri s√ºr√ºkleyip bƒ±rakabilirsiniz.",
                language: "Dil:",
                convertN: (n) => `${n} Resim(ler)i PDF'e D√∂n√º≈üt√ºr`,
                empty: "Dosya se√ßilmedi.",
                errorType: "Hata: Bazƒ± dosyalar atlandƒ±. Yalnƒ±zca .jpg veya .png dosyalarƒ±na izin verilir.",
                progress: (i, n) => `Resim ${i}/${n} i≈üleniyor`,
                progressPercent: (p) => `%${p}`,
                saving: "Kaydediliyor...",
                alertFinish: "D√∂n√º≈üt√ºrme tamamlandƒ±!",
                alertSuccess: (s) => `${s} resim ba≈üarƒ±yla d√∂n√º≈üt√ºr√ºld√º.`,
                alertFail: (f) => `${f} dosya ba≈üarƒ±sƒ±z oldu ve atlandƒ±:`,
                alertError: "Kritik bir hata olu≈ütu. L√ºtfen sayfayƒ± yenileyin ve daha az dosyayla tekrar deneyin."
            }
        };

        // --- 2. GLOBAL VARIABLES ---
        let uploadedFiles = [];
        const allowedTypes = ['image/jpeg', 'image/png'];
        let hasFileTypeError = false;
        let currentLang = 'en';

        // --- 3. GET ALL DOM ELEMENTS ---
        const allElements = {
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('imageInput'),
            convertBtn: document.getElementById('convertBtn'),
            clearBtn: document.getElementById('clearBtn'),
            fileListNames: document.getElementById('fileListNames'),
            reorderNote: document.getElementById('reorder-note'),
            qualitySelect: document.getElementById('qualitySelect'),
            fileNameInput: document.getElementById('fileNameInput'),
            pageSizeSelect: document.getElementById('pageSizeSelect'),
            pageOrientationSelect: document.getElementById('pageOrientationSelect'),
            darkModeToggle: document.getElementById('darkModeToggle'),
            progressBarContainer: document.getElementById('progress-bar-container'),
            progressBar: document.getElementById('progress-bar'),
            languageSelect: document.getElementById('languageSelect'),
            htmlTag: document.documentElement
        };

        // --- 4. CORE LANGUAGE FUNCTION ---
        function setLanguage(lang) {
            if (!translations[lang]) lang = 'en';
            currentLang = lang;
            
            allElements.htmlTag.setAttribute('lang', lang);
            allElements.htmlTag.setAttribute('dir', lang === 'ar' ? 'rtl' : 'ltr');
            
            document.title = translations[lang].title;
            
            document.querySelectorAll('[data-i18n-key]').forEach(el => {
                const key = el.getAttribute('data-i18n-key');
                if (translations[lang][key]) {
                    el.innerHTML = translations[lang][key];
                }
            });
            
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });
            
            localStorage.setItem('language', lang);
            updateDynamicState(); 
        }

        // --- 5. EVENT LISTENERS ---
        allElements.fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
        allElements.dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            allElements.dropZone.classList.add('drag-over');
        });
        allElements.dropZone.addEventListener('dragleave', (e) => {
            allElements.dropZone.classList.remove('drag-over');
        });
        allElements.dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            allElements.dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
        
        allElements.convertBtn.addEventListener('click', convertToPdf);
        
        allElements.clearBtn.addEventListener('click', () => {
            uploadedFiles = [];
            hasFileTypeError = false; 
            allElements.fileNameInput.value = '';
            redrawFileList(); 
            updateDynamicState();
        });

        allElements.fileListNames.addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return; 
            
            const idToActOn = target.getAttribute('data-id');
            const itemIndex = uploadedFiles.findIndex(item => item.id.toString() === idToActOn);
            if (itemIndex === -1) return;

            if (target.classList.contains('delete-btn')) {
                uploadedFiles.splice(itemIndex, 1);
                target.closest('.preview-card').remove();
                renumberList();
                updateDynamicState();
            } else if (target.classList.contains('rotate-btn')) {
                const item = uploadedFiles[itemIndex];
                item.rotation = (item.rotation + 90) % 360;
                const imgElement = target.closest('.preview-card').querySelector('.preview-img');
                imgElement.className = `preview-img rotate-${item.rotation}`;
            }
        });
        
        new Sortable(allElements.fileListNames, {
            animation: 150, 
            ghostClass: 'sortable-ghost', 
            chosenClass: 'sortable-chosen',
            filter: '.delete-btn, .rotate-btn',
            onEnd: function (evt) {
                const item = uploadedFiles.splice(evt.oldIndex, 1)[0];
                uploadedFiles.splice(evt.newIndex, 0, item);
                renumberList();
            }
        });

        allElements.darkModeToggle.addEventListener('change', () => {
            if (allElements.darkModeToggle.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        });
        
        allElements.languageSelect.addEventListener('change', (e) => {
            setLanguage(e.target.value);
        });
        
        // --- 6. HELPER FUNCTIONS ---
        
        async function handleFiles(files) {
            hasFileTypeError = false; 
            
            let newFiles = []; 
            for (const file of files) {
                if (allowedTypes.includes(file.type)) {
                    const dataURL = await readFileAsDataURL(file);
                    const id = Date.now() + Math.random(); 
                    const newItem = { file: file, dataURL: dataURL, id: id, rotation: 0 };
                    uploadedFiles.push(newItem);
                    newFiles.push(newItem); 
                } else {
                    hasFileTypeError = true; 
                }
            }
            
            drawNewFiles(newFiles);
            updateDynamicState();
        }

        function drawNewFiles(newFiles) {
            const emptyText = allElements.fileListNames.querySelector('.empty-text');
            if (emptyText) emptyText.remove();
            
            newFiles.forEach(item => {
                const index = uploadedFiles.indexOf(item);
                const card = document.createElement('div');
                card.className = 'preview-card';
                card.innerHTML = `
                    <span class="preview-number">${index + 1}.</span>
                    <img src="${item.dataURL}" alt="Preview" class="preview-img rotate-${item.rotation}">
                    <span class="preview-name" title="${item.file.name}">${item.file.name}</span>
                    <div class="preview-controls">
                        <button class="rotate-btn" data-id="${item.id}" title="Rotate 90¬∞">&#8635;</button>
                        <button class="delete-btn" data-id="${item.id}" title="Remove file">X</button>
                    </div>
                `;
                allElements.fileListNames.appendChild(card);
            });
        }
        
        function redrawFileList() {
            allElements.fileListNames.innerHTML = '';
        }

        function renumberList() {
            const cards = allElements.fileListNames.querySelectorAll('.preview-card');
            cards.forEach((card, index) => {
                const numberEl = card.querySelector('.preview-number');
                if (numberEl) numberEl.textContent = `${index + 1}.`;
            });
        }

        function updateDynamicState() {
            const langDict = translations[currentLang];
            
            const errorEl = allElements.fileListNames.querySelector('.error');
            const emptyEl = allElements.fileListNames.querySelector('.empty-text');
            if (errorEl) errorEl.remove();
            if (emptyEl) emptyEl.remove();

            if (hasFileTypeError) {
                const errElement = document.createElement('div');
                errElement.textContent = langDict.errorType;
                errElement.className = 'error';
                allElements.fileListNames.prepend(errElement);
            }
            
            if (uploadedFiles.length === 0) {
                allElements.reorderNote.style.display = 'none';
                
                if (!hasFileTypeError) {
                    allElements.fileListNames.innerHTML = `<div class="empty-text">${langDict.empty}</div>`;
                }
                allElements.convertBtn.disabled = true;
                allElements.clearBtn.disabled = true;
                allElements.convertBtn.textContent = langDict.convert;
            } else {
                allElements.reorderNote.style.display = 'block';
                allElements.convertBtn.disabled = false;
                allElements.clearBtn.disabled = false;
                allElements.convertBtn.textContent = langDict.convertN(uploadedFiles.length);
            }
        }

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = url;
            });
        }

        // --- 7. MAIN CONVERSION FUNCTION ---
        async function convertToPdf() {
            if (uploadedFiles.length === 0) return;
            const langDict = translations[currentLang];

            allElements.convertBtn.disabled = true;
            allElements.clearBtn.disabled = true;
            
            const totalFiles = uploadedFiles.length;
            let errorFiles = []; 
            const jpegQuality = parseFloat(allElements.qualitySelect.value);
            const fileName = allElements.fileNameInput.value.trim() || langDict.fileNamePlaceholder;
            const pageSize = allElements.pageSizeSelect.value;
            const orientation = allElements.pageOrientationSelect.value;
            
            allElements.progressBar.style.width = '0%';
            allElements.progressBar.textContent = langDict.progressPercent(0);
            allElements.progressBarContainer.style.display = 'block';

            let canvas = document.createElement('canvas');
            let ctx = canvas.getContext('2d');
            let doc = null; 

            try {
                doc = new jsPDF({
                    orientation: orientation,
                    unit: 'mm',
                    format: pageSize
                });
                
                const pdfWidth = doc.internal.pageSize.getWidth();
                const pdfHeight = doc.internal.pageSize.getHeight();

                for (let i = 0; i < uploadedFiles.length; i++) {
                    const item = uploadedFiles[i]; 
                    
                    let progress = Math.round(((i + 1) / totalFiles) * 100);
                    allElements.progressBar.style.width = `${progress}%`;
                    allElements.progressBar.textContent = langDict.progress(i + 1, totalFiles);
                    
                    try {
                        const img = await loadImage(item.dataURL);

                        let imgWidth = img.width;
                        let imgHeight = img.height;
                        let isSwapped = (item.rotation === 90 || item.rotation === 270);
                        
                        const w = isSwapped ? imgHeight : imgWidth;
                        const h = isSwapped ? imgWidth : imgHeight;

                        const ratio = Math.min(pdfWidth / w, pdfHeight / h);
                        const scaledWidth = w * ratio;
                        const scaledHeight = h * ratio;
                        const x = (pdfWidth - scaledWidth) / 2;
                        const y = (pdfHeight - scaledHeight) / 2;

                        canvas.width = w;
                        canvas.height = h;
                        
                        ctx.save();
                        ctx.translate(w / 2, h / 2);
                        ctx.rotate(item.rotation * Math.PI / 180);
                        ctx.drawImage(img, -img.width / 2, -img.height / 2);
                        ctx.restore();
                        
                        const jpegDataUrl = canvas.toDataURL('image/jpeg', jpegQuality);
                        
                        if (i > 0) {
                            doc.addPage();
                        }
                        
                        doc.addImage(
                            jpegDataUrl,
                            'JPEG',
                            x,
                            y,
                            scaledWidth,
                            scaledHeight
                        );
                        
                    } catch (imageError) {
                        console.error("Failed to add image:", item.file.name, imageError);
                        errorFiles.push(item.file.name);
                    }
                } 
                
                allElements.progressBar.textContent = langDict.saving;
                doc.save(fileName + '.pdf');

                if (errorFiles.length > 0) {
                    alert(
                        `${langDict.alertFinish}\n\n${langDict.alertSuccess(totalFiles - errorFiles.length)}\n\n` +
                        `${langDict.alertFail(errorFiles.length)}\n` +
                        errorFiles.join('\n')
                    );
                }

            } catch (criticalError) {
                console.error(criticalError);
                alert(langDict.alertError);
            } finally {
                if (canvas) {
                    canvas.width = 0;
                    canvas.height = 0;
                }
                canvas = null;
                ctx = null;
                doc = null;
                
                allElements.progressBarContainer.style.display = 'none';
                
                uploadedFiles = [];
                hasFileTypeError = false;
                allElements.fileNameInput.value = ''; 
                redrawFileList(); 
                updateDynamicState(); 
            }
        }

        // --- 8. INITIAL PAGE LOAD ---
        (function() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                allElements.darkModeToggle.checked = true;
                document.body.classList.add('dark-mode');
            }
            
            const savedLang = localStorage.getItem('language') || 'en';
            allElements.languageSelect.value = savedLang;
            setLanguage(savedLang);
            
            updateDynamicState();
        })();

    </script>
</body>
</html>
